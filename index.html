<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resource Calendar</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15, 23, 42, 0.10);
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-sm: 0 6px 18px rgba(15, 23, 42, 0.08);
      --ring: 0 0 0 4px rgba(59, 130, 246, 0.18);
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #dc2626;
      --radius: 16px;

      /* Bottom sheet */
      --sheet-bg: rgba(15, 23, 42, 0.45);
      --sheet-card: #ffffff;
      --sheet-radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(37, 99, 235, 0.08), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(16, 185, 129, 0.08), transparent 55%),
        var(--bg);
    }

    .topbar {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .titleBlock h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.02em;
    }

    .titleBlock p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .wrap {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      align-items: start;
    }

    .panel,
    #calendar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    .panel {
      padding: 14px;
      overflow: hidden;
    }

    .panelHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .panelHeader strong {
      font-size: 14px;
      letter-spacing: -0.01em;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.03);
      user-select: none;
    }

    .pill::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.8);
      display: inline-block;
    }

    .btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      appearance: none;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform .06s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
    }

    button:hover {
      background: rgba(15, 23, 42, 0.03);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0px);
    }

    button:focus {
      outline: none;
      box-shadow: var(--ring);
      border-color: rgba(37, 99, 235, 0.35);
    }

    #refreshBtn {
      grid-column: 1 / -1;
      background: var(--primary);
      color: #fff;
      border-color: rgba(37, 99, 235, 0.45);
    }

    #refreshBtn:hover {
      background: var(--primary-hover);
    }

    .bookBtn {
      display: block;
      margin: 12px 0 14px;
      padding: 12px 14px;
      text-align: center;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.35);
      transition: transform .08s ease, box-shadow .15s ease, filter .15s ease;
    }

    .bookBtn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 34px rgba(37, 99, 235, 0.45);
    }

    .bookBtn:active {
      transform: translateY(0);
    }

    #resourceToggles {
      margin-top: 12px;
      max-height: calc(100vh - 310px);
      overflow: auto;
      padding-right: 6px;
    }

    #resourceToggles::-webkit-scrollbar {
      width: 10px;
    }

    #resourceToggles::-webkit-scrollbar-thumb {
      background: rgba(15, 23, 42, 0.12);
      border-radius: 999px;
      border: 3px solid transparent;
      background-clip: content-box;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
      padding: 10px 10px;
      border: 1px solid transparent;
      border-radius: 14px;
      transition: background .12s ease, border-color .12s ease;
    }

    .row:hover {
      background: rgba(15, 23, 42, 0.03);
      border-color: rgba(15, 23, 42, 0.06);
    }

    .row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .row label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      line-height: 1.1;
      font-size: 13px;
      color: rgba(15, 23, 42, 0.86);
      user-select: none;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .error {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(220, 38, 38, 0.25);
      background: rgba(220, 38, 38, 0.06);
      color: var(--danger);
      font-size: 12px;
      white-space: pre-wrap;
    }

    #calendar {
      padding: 14px;
      min-height: 560px;
    }

    /* FullCalendar theme tweaks */
    .fc {
      --fc-border-color: rgba(15, 23, 42, 0.10);
      --fc-page-bg-color: transparent;
      --fc-today-bg-color: rgba(37, 99, 235, 0.08);
      --fc-small-font-size: 0.84em;
      --fc-event-border-color: transparent;
      --fc-event-text-color: #fff;
      --fc-event-bg-color: var(--primary);
      --fc-event-selected-overlay-color: rgba(0, 0, 0, 0.10);
    }

    .fc .fc-toolbar-title {
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .fc .fc-toolbar {
      flex-wrap: wrap;
      gap: 10px;
    }

    .fc .fc-toolbar-chunk {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .fc .fc-button {
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      background: #fff !important;
      color: rgba(15, 23, 42, 0.85) !important;
      padding: 8px 10px !important;
      font-weight: 600 !important;
      box-shadow: none !important;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
    }

    .fc .fc-button:hover {
      background: rgba(15, 23, 42, 0.04) !important;
      transform: translateY(-1px);
    }

    .fc .fc-button:active {
      transform: translateY(0px);
    }

    .fc .fc-button-primary:not(:disabled).fc-button-active {
      background: rgba(37, 99, 235, 0.10) !important;
      border-color: rgba(37, 99, 235, 0.25) !important;
      color: rgba(15, 23, 42, 0.9) !important;
    }

    .fc .fc-button-primary:focus {
      box-shadow: var(--ring) !important;
    }

    /* Events */
    .fc .fc-event,
    .fc .fc-daygrid-event {
      border-radius: 999px;
      padding: 2px 6px;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
    }

    .fc .fc-timegrid-event {
      border-radius: 12px;
      padding: 4px 6px;
    }

    .fc .fc-col-header-cell-cushion {
      padding: 10px 0;
      color: rgba(15, 23, 42, 0.65);
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    /* Make day cells feel tappable */
    .fc .fc-daygrid-day-frame {
      cursor: pointer;
    }

    .fc .fc-daygrid-day:hover .fc-daygrid-day-frame {
      background: rgba(15, 23, 42, 0.02);
    }

    /* Tooltip (desktop hover) */
    .tooltip {
      position: fixed;
      z-index: 9999;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      color: #fff;
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.22);
      pointer-events: none;
      transform: translate(10px, 10px);
    }

    .tooltip .tt-time {
      opacity: 0.85;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .tooltip .tt-title {
      font-weight: 600;
      word-break: break-word;
    }

    /* Hamburger + mobile drawer */
    .hamburger {
      display: none;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 800;
      color: rgba(15, 23, 42, 0.85);
      cursor: pointer;
      white-space: nowrap;
      align-items: center;
      gap: 8px;
    }

    .hamburger:hover {
      background: rgba(15, 23, 42, 0.03);
    }

    .iconBtn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(4px);
      display: none;
      z-index: 10000;
    }

    .overlay.open {
      display: block;
    }

    .drawer {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: min(92vw, 420px);
      background: var(--card);
      border-left: 1px solid var(--border);
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.25);
      padding: 12px;
      transform: translateX(100%);
      transition: transform .2s ease;
    }

    .overlay.open .drawer {
      transform: translateX(0);
    }

    .drawerHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .drawerBody {
      height: calc(100% - 60px);
      overflow: auto;
    }

    /* =========================
       Bottom Sheet (Day events)
       ========================= */
    .sheetOverlay {
      position: fixed;
      inset: 0;
      background: var(--sheet-bg);
      backdrop-filter: blur(4px);
      display: none;
      z-index: 11000;
    }

    .sheetOverlay.open {
      display: block;
    }

    .sheet {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--sheet-card);
      border-top-left-radius: var(--sheet-radius);
      border-top-right-radius: var(--sheet-radius);
      box-shadow: 0 -20px 60px rgba(15, 23, 42, 0.25);
      transform: translateY(110%);
      transition: transform .22s ease;
      max-height: 78vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sheetOverlay.open .sheet {
      transform: translateY(0);
    }

    .sheetHandle {
      width: 46px;
      height: 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.18);
      margin: 10px auto 6px;
    }

    .sheetHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 14px 12px;
      border-bottom: 1px solid var(--border);
    }

    .sheetHeader .left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .sheetTitle {
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sheetSubtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .sheetClose {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .sheetBody {
      padding: 10px 12px 14px;
      overflow: auto;
    }

    .eventList {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .eventItem {
      display: grid;
      grid-template-columns: 10px 1fr;
      gap: 10px;
      align-items: start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(15, 23, 42, 0.02);
      cursor: pointer;
      transition: transform .06s ease, background .12s ease;
    }

    .eventItem:hover {
      background: rgba(15, 23, 42, 0.035);
      transform: translateY(-1px);
    }

    .eventItem:active {
      transform: translateY(0);
    }

    .eventBar {
      width: 10px;
      border-radius: 999px;
      height: 100%;
      background: var(--primary);
      margin-top: 2px;
    }

    .eventMeta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .eventTime {
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .eventTitle {
      font-size: 13px;
      font-weight: 800;
      color: rgba(15, 23, 42, 0.92);
      line-height: 1.2;
      word-break: break-word;
    }

    .emptyState {
      padding: 16px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(15, 23, 42, 0.16);
      background: rgba(15, 23, 42, 0.02);
      color: var(--muted);
      font-size: 13px;
    }

    /* =========================
       Mobile-first behavior
       ========================= */
    .container {
      width: 100%;
      margin: 14px auto;
      padding: 0 12px 18px;
    }

    .wrap {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .wrap>#filtersPanel {
      display: none;
    }

    .hamburger {
      display: inline-flex;
    }

    #drawerBody #filtersPanel {
      display: block !important;
    }

    #calendar {
      padding: 10px;
      min-height: 520px;
    }

    .tooltip {
      max-width: 260px;
      font-size: 11px;
    }

    /* Tighten FullCalendar for phones */
    @media (max-width: 520px) {
      .titleBlock h1 {
        font-size: 18px;
      }

      .titleBlock p {
        font-size: 12px;
      }

      .fc .fc-toolbar-title {
        font-size: 16px;
      }

      .fc .fc-button {
        padding: 7px 8px !important;
        font-size: 12px !important;
        border-radius: 12px !important;
      }

      /* smaller event chips */
      .fc .fc-daygrid-event {
        padding: 1px 5px;
        font-size: 11px;
      }

      .fc .fc-daygrid-day-number {
        font-size: 12px;
        padding: 6px 6px 0 0;
      }

      /* reduce header height */
      .fc .fc-col-header-cell-cushion {
        padding: 8px 0;
        font-size: 11px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="titleBlock">
        <h1>Resource Calendar</h1>
        <p>Filter resources. Click an event to open it in Google Calendar.</p>
      </div>

      <button id="openFiltersBtn" class="hamburger" type="button" aria-label="Open filters">
        ☰ Filters
      </button>
    </div>

    <div class="wrap">
      <div id="filtersPanel" class="panel">
        <div class="panelHeader">
          <strong>Resources</strong>
          <span id="countPill" class="pill">0 shown</span>
        </div>

        <div class="btns">
          <button id="selectAllBtn" type="button">Select all</button>
          <button id="selectNoneBtn" type="button">Select none</button>
          <button id="refreshBtn" type="button">Refresh</button>
        </div>

        <div id="resourceToggles"></div>
        <div id="errorBox" class="error" style="display:none;"></div>

        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdzEOgF4tvf9vKROKLOKXAbacnDnUyAEUcnRUYI6clOhtwGeA/viewform?usp=publish-editor"
          target="_blank" rel="noopener noreferrer" class="bookBtn">
          + Book a Resource
        </a>
      </div>

      <div id="calendar"></div>
    </div>
  </div>

  <!-- Mobile drawer overlay -->
  <div id="filtersOverlay" class="overlay" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true" aria-label="Filters">
      <div class="drawerHeader">
        <strong>Filters</strong>
        <button id="closeFiltersBtn" class="iconBtn" type="button" aria-label="Close filters">✕</button>
      </div>
      <div id="drawerBody" class="drawerBody"></div>
    </div>
  </div>

  <!-- Day Events Bottom Sheet -->
  <div id="daySheetOverlay" class="sheetOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Events for selected day">
      <div class="sheetHandle"></div>
      <div class="sheetHeader">
        <div class="left">
          <div id="sheetTitle" class="sheetTitle">Day</div>
          <div id="sheetSubtitle" class="sheetSubtitle">0 events</div>
        </div>
        <button id="sheetCloseBtn" class="sheetClose" type="button" aria-label="Close">✕</button>
      </div>
      <div class="sheetBody">
        <div id="sheetList" class="eventList"></div>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * CONFIG:
     *****************************************************************/
    const GOOGLE_API_KEY = "AIzaSyCmlYXwSAPkVqB5_a3JHdDjmzGsBNHVOqE";
    const GOOGLE_CALENDAR_ID = "asstgs.saskbaiturrahmat@ahmadiyya.ca";

    /*****************************************************************
     * RESOURCE DEFINITIONS (fixed list) + COLORS
     *****************************************************************/
    const RESOURCES = [
      "BR - Lajna Prayer Hall",
      "BR - Lajna Classroom",
      "BR - Lajna Kitchen",
      "BR - Lajna Kids Room",
      "BR - Lajna Lobby",
      "BR - Gym",
      "BR - Library",
      "BR - Board Room",
      "BR - Outside Kitchen",
      "BR - Men's Prayer Hall",
      "BR - Men's Kitchen",
      "BA - Lajna Prayer Hall",
      "BA - Men's Prayer Hall",
    ];

    const COLOR_PALETTE = [
      "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
      "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
      "#0f766e", "#b45309", "#4338ca",
    ];

    const RESOURCE_COLOR = Object.fromEntries(
      RESOURCES.map((r, i) => [r, COLOR_PALETTE[i % COLOR_PALETTE.length]])
    );

    /*****************************************************************
     * Helpers
     *****************************************************************/
    let activeTooltipEl = null;

    function formatTimeRange(event) {
      if (event.allDay) return "All day";

      const start = event.start;
      const end = event.end;
      const opts = { hour: "numeric", minute: "2-digit" };

      const s = start ? start.toLocaleTimeString([], opts) : "";
      const e = end ? end.toLocaleTimeString([], opts) : "";

      return e ? `${s} – ${e}` : s;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showTooltip(info, jsEvent) {
      // On touch devices, tooltips are annoying.
      if (window.matchMedia("(pointer: coarse)").matches) return;

      hideTooltip();
      const el = document.createElement("div");
      el.className = "tooltip";

      const time = formatTimeRange(info.event);
      const title = info.event.title || "";

      el.innerHTML = `
        <div class="tt-time">${escapeHtml(time)}</div>
        <div class="tt-title">${escapeHtml(title)}</div>
      `;

      document.body.appendChild(el);
      activeTooltipEl = el;
      moveTooltip(jsEvent);
    }

    function moveTooltip(jsEvent) {
      if (!activeTooltipEl) return;

      const pad = 14;
      const w = activeTooltipEl.offsetWidth;
      const h = activeTooltipEl.offsetHeight;

      let x = jsEvent.clientX + pad;
      let y = jsEvent.clientY + pad;

      if (x + w > window.innerWidth - 8) x = jsEvent.clientX - w - pad;
      if (y + h > window.innerHeight - 8) y = jsEvent.clientY - h - pad;

      activeTooltipEl.style.left = `${x}px`;
      activeTooltipEl.style.top = `${y}px`;
    }

    function hideTooltip() {
      if (activeTooltipEl) {
        activeTooltipEl.remove();
        activeTooltipEl = null;
      }
    }

    function getColorForResource(r) {
      if (!r) return null;
      if (RESOURCE_COLOR[r]) return RESOURCE_COLOR[r];

      let hash = 0;
      for (let i = 0; i < r.length; i++) hash = (hash * 31 + r.charCodeAt(i)) >>> 0;
      return COLOR_PALETTE[hash % COLOR_PALETTE.length];
    }

    function toIso(d) { return d.toISOString(); }

    function parseResource(summary) {
      const s = (summary || "").trim();
      const parts = s.split("|");
      if (parts.length === 2) {
        const resource = parts[0].trim();
        const title = parts[1].trim() || "(No title)";
        return { resource, title };
      }
      return { resource: null, title: s || "(No title)" };
    }

    function googleEventsUrl(timeMinIso, timeMaxIso) {
      const base = "https://www.googleapis.com/calendar/v3/calendars/" +
        encodeURIComponent(GOOGLE_CALENDAR_ID) + "/events";
      const params = new URLSearchParams({
        key: GOOGLE_API_KEY,
        timeMin: timeMinIso,
        timeMax: timeMaxIso,
        singleEvents: "true",
        orderBy: "startTime",
        maxResults: "2500",
      });
      return `${base}?${params.toString()}`;
    }

    async function fetchGoogleEvents(timeMin, timeMax) {
      const url = googleEventsUrl(toIso(timeMin), toIso(timeMax));
      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Google API error (${res.status}).\n${text}`);
      }
      const data = await res.json();
      return data.items || [];
    }

    function startOfDay(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function endOfDay(date) {
      const d = new Date(date);
      d.setHours(23, 59, 59, 999);
      return d;
    }

    // Does event overlap day?
    function eventOverlapsDay(event, dayDate) {
      const dayStart = startOfDay(dayDate);
      const dayEnd = endOfDay(dayDate);

      const evStart = event.start ? new Date(event.start) : null;
      const evEnd = event.end ? new Date(event.end) : null;

      if (!evStart) return false;

      // FullCalendar all-day events often have end at next day 00:00 exclusive
      // Our overlap check handles this.
      const aStart = evStart;
      const aEnd = evEnd ? evEnd : evStart;

      return aStart <= dayEnd && aEnd >= dayStart;
    }

    function formatDayHeader(dateObj) {
      // e.g., "Fri, Feb 13, 2026"
      return dateObj.toLocaleDateString([], { weekday: "short", month: "short", day: "numeric", year: "numeric" });
    }

    function localDateFromDateStr(dateStr) {
      // dateStr like "2026-02-13"
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(y, m - 1, d); // local midnight
    }


    /*****************************************************************
     * State
     *****************************************************************/
    const state = {
      selectedResources: new Set(),
      availableResources: [],
      cachedEvents: [],
      didInitSelection: false,
    };

    function setError(msg) {
      const el = document.getElementById("errorBox");
      if (!msg) {
        el.textContent = "";
        el.style.display = "none";
        return;
      }
      el.textContent = msg;
      el.style.display = "block";
    }

    function updateCountPill(shownCount) {
      document.getElementById("countPill").textContent = `${shownCount} shown`;
    }

    function renderToggles() {
      const holder = document.getElementById("resourceToggles");
      holder.innerHTML = "";

      if (state.availableResources.length === 0) {
        holder.innerHTML = `<div class="muted" style="padding:10px 2px;">No resources found in this date range.</div>`;
        return;
      }

      for (const r of state.availableResources) {
        const id = "res_" + r.replace(/\W+/g, "_");
        const row = document.createElement("div");
        row.className = "row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = id;
        cb.checked = state.selectedResources.has(r);

        cb.addEventListener("change", () => {
          if (cb.checked) state.selectedResources.add(r);
          else state.selectedResources.delete(r);
          calendar.refetchEvents();
        });

        const label = document.createElement("label");
        label.setAttribute("for", id);

        const dot = document.createElement("span");
        dot.style.width = "10px";
        dot.style.height = "10px";
        dot.style.borderRadius = "999px";
        dot.style.display = "inline-block";
        dot.style.background = getColorForResource(r);
        dot.style.marginRight = "6px";

        label.appendChild(dot);
        label.appendChild(document.createTextNode(r));

        row.appendChild(cb);
        row.appendChild(label);
        holder.appendChild(row);
      }
    }

    function buildResourceListFromCached() {
      state.availableResources = [...RESOURCES];
      if (!state.didInitSelection) {
        for (const r of state.availableResources) state.selectedResources.add(r);
        state.didInitSelection = true;
      }
    }

    function toFullCalendarEvent(googleItem) {
      const summary = googleItem.summary || "(No title)";
      const { resource, title } = parseResource(summary);

      const start = googleItem.start?.dateTime || googleItem.start?.date;
      const end = googleItem.end?.dateTime || googleItem.end?.date;

      const displayTitle = resource ? `${resource} - ${title}` : summary;
      const color = getColorForResource(resource);

      return {
        id: googleItem.id,
        title: displayTitle,
        start,
        end,
        allDay: !!googleItem.start?.date,
        backgroundColor: color || undefined,
        borderColor: color || undefined,
        textColor: color ? "#ffffff" : undefined,
        extendedProps: {
          resource,
          rawTitle: title,
          htmlLink: googleItem.htmlLink || null,
        }
      };
    }

    /*****************************************************************
     * Bottom sheet logic
     *****************************************************************/
    const sheetOverlay = document.getElementById("daySheetOverlay");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetSubtitle = document.getElementById("sheetSubtitle");
    const sheetList = document.getElementById("sheetList");
    const sheetCloseBtn = document.getElementById("sheetCloseBtn");

    function openDaySheet(dateObj) {
      // Pull currently rendered (filtered) events from FullCalendar:
      const all = calendar.getEvents();

      const dayEvents = all
        .filter(ev => eventOverlapsDay(ev, dateObj))
        .sort((a, b) => {
          // All-day first, then time
          if (a.allDay && !b.allDay) return -1;
          if (!a.allDay && b.allDay) return 1;
          const as = a.start ? a.start.getTime() : 0;
          const bs = b.start ? b.start.getTime() : 0;
          return as - bs;
        });

      sheetTitle.textContent = formatDayHeader(dateObj);
      sheetSubtitle.textContent = `${dayEvents.length} event${dayEvents.length === 1 ? "" : "s"}`;
      sheetList.innerHTML = "";

      if (dayEvents.length === 0) {
        sheetList.innerHTML = `<div class="emptyState">No bookings for this day.</div>`;
      } else {
        for (const ev of dayEvents) {
          const barColor = ev.backgroundColor || getColorForResource(ev.extendedProps?.resource) || "#2563eb";
          const timeText = formatTimeRange(ev);
          const titleText = ev.title || "(No title)";
          const link = ev.extendedProps?.htmlLink;

          const item = document.createElement("div");
          item.className = "eventItem";
          item.innerHTML = `
            <div class="eventBar" style="background:${escapeHtml(barColor)}"></div>
            <div class="eventMeta">
              <div class="eventTime">${escapeHtml(timeText)}</div>
              <div class="eventTitle">${escapeHtml(titleText)}</div>
            </div>
          `;

          item.addEventListener("click", () => {
            if (link) window.open(link, "_blank");
          });

          sheetList.appendChild(item);
        }
      }

      sheetOverlay.classList.add("open");
      sheetOverlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeDaySheet() {
      sheetOverlay.classList.remove("open");
      sheetOverlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    sheetCloseBtn.addEventListener("click", closeDaySheet);
    sheetOverlay.addEventListener("click", (e) => {
      // close if clicking outside the card
      if (e.target === sheetOverlay) closeDaySheet();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        // Close sheet first if open, else close filters
        if (sheetOverlay.classList.contains("open")) closeDaySheet();
      }
    });

    /*****************************************************************
     * FullCalendar init
     *****************************************************************/
    const calendarEl = document.getElementById("calendar");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
      },
      height: "auto",
      nowIndicator: true,

      // ✅ Limit how many events show inside a day box (month view)
      dayMaxEvents: 3,
      dayMaxEventRows: 3,

      // ✅ When "+X more" is tapped, open our sheet instead of FC popover
      moreLinkClick: function () {
        return false; // completely disable "+X more"
      },



      // ✅ Clicking the day cell opens our sheet (month/dayGrid views)
      dateClick: function (info) {
        if (info.view.type.startsWith("dayGrid")) {
          openDaySheet(localDateFromDateStr(info.dateStr));
        }
      },


      // Tooltips only matter on desktop anyway; your showTooltip already skips touch
      eventMouseEnter: function (info) { showTooltip(info, info.jsEvent); },
      eventMouseLeave: function () { hideTooltip(); },
      eventMouseMove: function (info) { moveTooltip(info.jsEvent); },

      // ✅ In busy days (>3 events), don't open Google Calendar from month view.
      //    Instead, open the sheet so user can pick the exact event.
      eventClick: function (info) {
        const link = info.event.extendedProps.htmlLink;

        if (info.view.type.startsWith("dayGrid")) {
          const clickedDay = info.event.start;
          const countThatDay = calendar.getEvents().filter(ev => eventOverlapsDay(ev, clickedDay)).length;

          if (countThatDay > 3) {
            openDaySheet(clickedDay);
            return;
          }
        }

        if (link) window.open(link, "_blank");
      },

      events: async function (fetchInfo, successCallback, failureCallback) {
        try {
          setError("");

          state.cachedEvents = await fetchGoogleEvents(fetchInfo.start, fetchInfo.end);

          buildResourceListFromCached();
          renderToggles();

          const fcEvents = state.cachedEvents
            .map(toFullCalendarEvent)
            .filter(e => {
              const r = e.extendedProps.resource;
              if (!r) return state.selectedResources.size > 0;
              return state.selectedResources.has(r);
            });

          updateCountPill(state.selectedResources.size);
          successCallback(fcEvents);
        } catch (err) {
          setError(err.message || String(err));
          failureCallback(err);
        }
      }
    });

    calendar.render();

    /*****************************************************************
     * Buttons
     *****************************************************************/
    document.getElementById("selectAllBtn").addEventListener("click", () => {
      for (const r of state.availableResources) state.selectedResources.add(r);
      renderToggles();
      calendar.refetchEvents();
    });

    document.getElementById("selectNoneBtn").addEventListener("click", () => {
      state.selectedResources.clear();
      renderToggles();
      calendar.refetchEvents();
    });

    document.getElementById("refreshBtn").addEventListener("click", () => {
      calendar.refetchEvents();
    });

    /*****************************************************************
     * Mobile Filters Drawer (layout only; does not touch calendar logic)
     *****************************************************************/
    const overlay = document.getElementById("filtersOverlay");
    const openBtn = document.getElementById("openFiltersBtn");
    const closeBtn = document.getElementById("closeFiltersBtn");
    const filtersPanel = document.getElementById("filtersPanel");
    const drawerBody = document.getElementById("drawerBody");

    const originalParent = filtersPanel.parentElement;
    const originalNextSibling = filtersPanel.nextElementSibling;

    function useDrawerFilters() {
      return true; // always keep filters in drawer
    }

    function ensurePanelLocation() {
      if (useDrawerFilters()) {
        if (filtersPanel.parentElement !== drawerBody) {
          drawerBody.appendChild(filtersPanel);
        }
      } else {
        if (filtersPanel.parentElement !== originalParent) {
          if (originalNextSibling) originalParent.insertBefore(filtersPanel, originalNextSibling);
          else originalParent.appendChild(filtersPanel);
        }
        overlay.classList.remove("open");
        overlay.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
      }
    }

    function openDrawer() {
      ensurePanelLocation();
      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeDrawer() {
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    openBtn.addEventListener("click", openDrawer);
    closeBtn.addEventListener("click", closeDrawer);

    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeDrawer();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (overlay.classList.contains("open")) closeDrawer();
      }
    });

    window.addEventListener("resize", ensurePanelLocation);
    ensurePanelLocation();
  </script>

</body>

</html>